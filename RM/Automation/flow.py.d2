import os
import wget

def obfuscation(ApkFileName):
    obfuscat = "docker run --rm -it obfuscapk -p -w /tmp/ -o RandomManifest -o Rebuild -d OutputAPK/" + ApkFileName +" "+ ApkFileName
    os.system(obfuscat)
    os.chdir("OutputAPK")
    os.system("ls")
    static_analysis(ApkFileName)
    os.chdir("/home/mrrobot/Desktop/RM2/Obfuscapk/src/")
    os.system("ls")

def static_analysis(ApkFileName):
    command="quark -a "+ApkFileName+" -s -c -o "+ApkFileName+"_output.json"
    os.system(command)
    print("Static Analysis"+ApkFileName)

def last_processed_APK():
    file = open("count.txt", "r")
    count = file.readline()
    print (count)
    count = int(count)
    file.close()
    return count-1

def processed_APK(Number):
    file = open("count.txt", "w")
    file.write(str(Number))
    file.close()

if __name__ == '__main__':
    try:
        print("Downloading APK File....")
        count = last_processed_APK()
        file = open("sha256.txt", "r")
        lines = file.readlines()
        print(len(lines))
        LinesInFile = len(lines)
        print (count)
        print (LinesInFile)
        for i in range(count,LinesInFile):
            download1="https://androzoo.uni.lu/api/download?apikey=1fad2754d5ed9728b4f94ea343008c3427830f11a6e55baaa0b951642c44c6bb&sha256="+lines[i]
            ApkFileName=wget.download(download1)
            print(ApkFileName)
            static_analysis(ApkFileName)
            print("Static Analysis is Done(Without obfuscation)")
            obfuscation(ApkFileName)
            print("Static Analysis is Done(With obfuscation)")
            print("Back to main")
            processed_APK(i)
        file.close()
    except KeyboardInterrupt:
        print('Hello user you have pressed ctrl-c button.')
        processed_APK(i)
        print("Thank You")